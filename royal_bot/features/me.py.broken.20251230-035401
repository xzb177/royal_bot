# -*- coding: utf-8 -*-
from telegram.ext import CommandHandler

def _title_by_xp(xp: int) -> str:
    if xp >= 20000: return "ğŸ’ <b>é»‘é‡‘è‡³å°Šè‚¡ä¸œ</b>"
    if xp >= 8000:  return "ğŸ‘‘ <b>ä¼šæ‰€è‘£äº‹</b>"
    if xp >= 2000:  return "ğŸ¥‚ <b>å°Šè´µè€æ¿</b>"
    if xp >= 500:   return "ğŸŸï¸ <b>è´µå®¾</b>"
    return "ğŸ‘¤ <b>æ¥å®¾</b>"

def _collector_title(cnt: dict) -> str:
    L = cnt.get("LEGENDARY", 0)
    E = cnt.get("EPIC", 0)
    R = cnt.get("RARE", 0)
    T = cnt.get("TOTAL", 0)

    # æ’é¢ä¼˜å…ˆï¼šä¼ è¯´ > å²è¯— > ç¨€æœ‰ > æ™®é€š
    if L >= 10: return "ğŸ† <b>ä¼ è¯´é¦†ä¸»</b>"
    if L >= 3:  return "ğŸ† <b>ä¼ è¯´æ”¶è—å®¶</b>"
    if E >= 15: return "ğŸ’ <b>å²è¯—é¦†ä¸»</b>"
    if E >= 5:  return "ğŸ’ <b>å²è¯—æ”¶è—å®¶</b>"
    if R >= 10: return "ğŸŸï¸ <b>ç¨€æœ‰æ”¶è—å®¶</b>"
    if T >= 20: return "ğŸ–¼ï¸ <b>ç”»å»Šå¸¸å®¢</b>"
    return "ğŸ§¾ <b>éšç¼˜æ”¶è—è€…</b>"

def register(app, ctx):
    ui = ctx["ui"]
    db = ctx["db"]

    async def me_cmd(update, context):
        # Emby ç»‘å®šå±•ç¤ºï¼ˆç¨³å®šç‰ˆï¼šæ²¡æ‹¿åˆ°å°±æ˜¾ç¤ºæœªç»‘å®šï¼‰
        emby_name = None
        try:
        bind = await db.get_binding(update.effective_user.id)
        if isinstance(bind, (tuple, list)) and len(bind) >= 2:
            emby_name = bind[1]
        except Exception:
        pass
        if not emby_name:
        emby_name = "æœªç»‘å®š"

        u = update.effective_user
        xp, streak, last_active, last_msg_ts, w, l, pe, pl = await db.get_user(u.id)
        title = _title_by_xp(xp)

        bind = await db.get_binding(u.id)

        # æµ·æŠ¥æ”¶è—ç§°å·
        cnt = await db.poster_counts_by_tier(u.id)
        collector = _collector_title(cnt)

        # èµ›å­£ç§°å·ï¼ˆæ¥è‡ª /shop è´­ä¹°ï¼‰
        active_title = await db.get_cosmetic(u.id, "active_title")
        active_title = active_title or "ï¼ˆæœªè£…å¤‡ï¼‰"

        # Emby ç»‘å®šä¿¡æ¯
        bind = await db.get_binding(u.id)

        # ä¸»æ­¦å™¨ï¼ˆå¦‚æœæœ‰ï¼‰
        topw = await db.top_weapon(u.id)
        weapon_line = topw[1] if topw else "ï¼ˆæœªè´­å…¥ï¼‰"

        lines = [

            ui.kv("Embyè´¦å·", f"<b>{emby_name}</b>"),
            ui.kv("å°Šå·", title),
            ui.kv("æ”¶è—ç§°å·", collector),
            ui.kv("èµ›å­£ç§°å·", f"<b>{active_title}</b>"),
            ui.kv("XP", f"<b>{xp}</b>"),
            ui.kv("è¿èƒœ", f"<b>{streak}</b> å¤©"),
            ui.kv("å†³æ–—æˆ˜ç»©", f"<b>{w}</b>èƒœ / <b>{l}</b>è´Ÿ"),
            ui.kv("æµ·æŠ¥åº“å­˜", f"ğŸ†{cnt.get('LEGENDARY',0)}  ğŸ’{cnt.get('EPIC',0)}  ğŸŸï¸{cnt.get('RARE',0)}  ğŸ§¾{cnt.get('COMMON',0)}"),
            ui.kv("ä¸»æ­¦å™¨", f"<b>{weapon_line}</b>"),
        ]
        await update.effective_message.reply_html(ui.panel("ğŸ§¾ VIP èº«ä»½å¡", lines, "æ’é¢ä¸æ˜¯å–Šå‡ºæ¥çš„ï¼Œæ˜¯æ”¶è—+æˆ˜ç»© ğŸ˜"))

    app.add_handler(CommandHandler("me", me_cmd))
